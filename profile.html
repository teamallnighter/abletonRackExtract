<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Ableton Rack Analyzer</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <header>
        <h1>Ableton Rack Analyzer</h1>
        <p class="subtitle">Your Profile</p>
    </header>

    <main class="profile-container">
        <div id="greeting" class="greeting"></div>

        <h2>Your Racks</h2>
        <div class="rack-list" id="rack-list">
            <p id="no-racks-message" class="no-racks-message">Loading racks...</p>
        </div>

        <div class="profile-actions">
            <a href="/" class="btn btn-secondary">Upload New Rack</a>
            <button onclick="logout()" class="btn btn-primary">Logout</button>
        </div>
    </main>

    <script>
        // Fetching user info from localStorage
        const user = JSON.parse(localStorage.getItem('user'));
        const token = localStorage.getItem('token');

        // Redirect to login if not authenticated
        if (!user || !token) {
            window.location.href = '/login';
        }

        // Display user greeting
        const greetingDiv = document.getElementById('greeting');
        greetingDiv.textContent = `Welcome, ${user.username}!`;

        // Fetch user racks
        async function fetchUserRacks() {
            try {
                const response = await fetch('/api/user/racks', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    greetingDiv.textContent = 'Failed to fetch racks.';
                    return;
                }

                const data = await response.json();
                const rackList = document.getElementById('rack-list');
                const noRacksMessage = document.getElementById('no-racks-message');
                
                // Clear loading message
                rackList.innerHTML = '';
                
                if (data.racks && data.racks.length > 0) {
                    data.racks.forEach(rack => {
                        const rackItem = document.createElement('div');
                        rackItem.classList.add('rack-item');
                        rackItem.classList.add('clickable');
                        
                        rackItem.innerHTML = `
                            <h3>${rack.name.replace(/_/g, ' ')}</h3>
                            <div class="rack-info">
                                <span>Uploaded: ${new Date(rack.created_at).toLocaleString()}</span><br>
                                <span>Chains: ${rack.chain_count || 0} | Devices: ${rack.device_count || 0}</span>
                            </div>
                        `;
                        
                        // Make rack clickable
                        rackItem.onclick = () => {
                            window.location.href = `/rack/${rack._id}`;
                        };
                        
                        rackList.appendChild(rackItem);
                    });
                } else {
                    rackList.innerHTML = '<p class="no-racks-message">You haven\'t uploaded any racks yet.</p>';
                }
                
            } catch (error) {
                greetingDiv.textContent = 'Error loading racks.';
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        // Fetch racks on page load
        fetchUserRacks();
    </script>
</body>
</html>
