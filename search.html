<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Racks - Ableton Rack Analyzer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Ableton Rack Analyzer</h1>
        <p class="subtitle">Search and explore analyzed racks</p>
    </header>

    <main class="search-container">
        <a href="/" class="back-link">← Back to Analyzer</a>
        
        <div class="search-header">
            <h2>Search Racks</h2>
        </div>
        
        <div class="search-controls">
            <div class="search-input-group">
                <input 
                    type="text" 
                    id="search-input" 
                    class="search-input" 
                    placeholder="Search by rack name, filename, or description..."
                    autofocus
                >
                <button id="search-button" class="search-button">Search</button>
            </div>
            
            <div class="filter-tags">
                <label class="filter-tags-label">Filter by tags:</label>
                <div id="filter-tags-container" class="filter-tags-container">
                    <!-- Popular tags will be loaded here -->
                </div>
            </div>
        </div>
        
        <div class="search-results">
            <div class="results-header">
                <h3>Results</h3>
                <span id="results-count" class="results-count"></span>
            </div>
            
            <div id="loading-spinner" class="loading-spinner hidden">
                <div class="spinner"></div>
                <p>Searching...</p>
            </div>
            
            <div id="rack-grid" class="rack-grid">
                <!-- Search results will be displayed here -->
            </div>
            
            <div id="no-results" class="no-results hidden">
                <p>No racks found. Try a different search term or adjust your filters.</p>
            </div>
        </div>
    </main>

    <!-- Rack Detail Modal -->
    <div id="rack-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-rack-name">Rack Details</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="rack-detail-info">
                    <div class="rack-detail-meta">
                        <div class="rack-detail-meta-item">
                            <div class="rack-detail-meta-label">Producer</div>
                            <div class="rack-detail-meta-value" id="modal-producer">-</div>
                        </div>
                        <div class="rack-detail-meta-item">
                            <div class="rack-detail-meta-label">Created</div>
                            <div class="rack-detail-meta-value" id="modal-date">-</div>
                        </div>
                        <div class="rack-detail-meta-item">
                            <div class="rack-detail-meta-label">Type</div>
                            <div class="rack-detail-meta-value" id="modal-type">-</div>
                        </div>
                    </div>
                    
                    <div class="rack-detail-description" id="modal-description">
                        No description provided
                    </div>
                    
                    <div class="rack-detail-tags" id="modal-tags">
                        <!-- Tags will be inserted here -->
                    </div>
                </div>
                
                <div class="rack-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="stat-chains">0</div>
                        <div class="stat-label">Chains</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-devices">0</div>
                        <div class="stat-label">Devices</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-macros">0</div>
                        <div class="stat-label">Macros</div>
                    </div>
                </div>
                
                <div class="visualization">
                    <h3>Signal Flow</h3>
                    <div id="modal-chains-container" class="chains-container">
                        <!-- Chains will be visualized here -->
                    </div>
                </div>
                
                <div id="modal-macro-controls" class="macro-controls hidden">
                    <h3>Macro Controls</h3>
                    <div id="modal-macro-list" class="macro-list">
                        <!-- Macros will be listed here -->
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="downloadJSON()">Download JSON</button>
                    <button class="btn btn-primary" onclick="closeModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        let selectedTags = new Set();
        let popularTags = [];
        let currentSearchQuery = '';
        let currentRackData = null;

        // DOM elements
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const filterTagsContainer = document.getElementById('filter-tags-container');
        const rackGrid = document.getElementById('rack-grid');
        const resultsCount = document.getElementById('results-count');
        const loadingSpinner = document.getElementById('loading-spinner');
        const noResults = document.getElementById('no-results');

        // Load popular tags
        async function loadPopularTags() {
            try {
                const response = await fetch('/api/tags/popular');
                const data = await response.json();
                
                if (data.success && data.tags) {
                    popularTags = data.tags;
                    renderFilterTags();
                }
            } catch (error) {
                console.error('Failed to load popular tags:', error);
            }
        }

        // Render filter tags
        function renderFilterTags() {
            filterTagsContainer.innerHTML = popularTags.map(tag => `
                <div class="filter-tag" data-tag="${tag.name}">
                    ${tag.name} (${tag.count})
                </div>
            `).join('');
            
            // Add click handlers
            filterTagsContainer.querySelectorAll('.filter-tag').forEach(el => {
                el.addEventListener('click', () => toggleTag(el.dataset.tag));
            });
        }

        // Toggle tag selection
        function toggleTag(tag) {
            if (selectedTags.has(tag)) {
                selectedTags.delete(tag);
            } else {
                selectedTags.add(tag);
            }
            
            // Update UI
            filterTagsContainer.querySelectorAll('.filter-tag').forEach(el => {
                if (selectedTags.has(el.dataset.tag)) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });
            
            // Perform search with updated filters
            performSearch();
        }

        // Perform search
        async function performSearch() {
            const query = searchInput.value.trim();
            currentSearchQuery = query;
            
            // Show loading state
            loadingSpinner.classList.remove('hidden');
            rackGrid.innerHTML = '';
            noResults.classList.add('hidden');
            
            try {
                let results = [];
                
                // If we have selected tags, search by tags
                if (selectedTags.size > 0) {
                    const tagResponse = await fetch('/api/racks/by-tags', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tags: Array.from(selectedTags) })
                    });
                    const tagData = await tagResponse.json();
                    
                    if (tagData.success) {
                        results = tagData.racks || [];
                    }
                }
                
                // If we have a text query, either filter tag results or search by text
                if (query) {
                    if (selectedTags.size > 0) {
                        // Filter existing results by query
                        results = results.filter(rack => {
                            const searchStr = `${rack.name || ''} ${rack.filename || ''} ${rack.user_info?.description || ''}`.toLowerCase();
                            return searchStr.includes(query.toLowerCase());
                        });
                    } else {
                        // Search by text only
                        const textResponse = await fetch(`/api/racks/search?q=${encodeURIComponent(query)}`);
                        const textData = await textResponse.json();
                        
                        if (textData.success) {
                            results = textData.racks || [];
                        }
                    }
                } else if (selectedTags.size === 0) {
                    // No query and no tags - show recent racks
                    const recentResponse = await fetch('/api/racks?limit=20');
                    const recentData = await recentResponse.json();
                    
                    if (recentData.success) {
                        results = recentData.racks || [];
                    }
                }
                
                // Display results
                displayResults(results);
                
            } catch (error) {
                console.error('Search failed:', error);
                showError('Search failed. Please try again.');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        // Display search results
        function displayResults(racks) {
            if (racks.length === 0) {
                noResults.classList.remove('hidden');
                resultsCount.textContent = '0 racks found';
                return;
            }
            
            noResults.classList.add('hidden');
            resultsCount.textContent = `${racks.length} rack${racks.length !== 1 ? 's' : ''} found`;
            
                rackGrid.innerHTML = racks.map(rack => {
                const userInfo = rack.user_info || {};
                const tags = rack.tags || userInfo.tags || [];
                const description = userInfo.description || 'No description provided';
                const producer = userInfo.producer_name || 'Unknown';
                const date = new Date(rack.created_at).toLocaleDateString();
                
                return `
                    <div class="rack-card" onclick="viewRack('${rack._id}')">
                        <h3>${rack.rack_name || rack.filename}</h3>
                        <div class="rack-card-meta">
                            by ${producer} • ${date}
                        </div>
                        <div class="rack-card-description">${description}</div>
                        ${tags.length > 0 ? `
                            <div class="rack-card-tags">
                                ${tags.map(tag => `<span class="rack-card-tag">${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // View rack details (made global for onclick)
        window.viewRack = async function(rackId) {
            try {
                // Fetch rack details
                const response = await fetch(`/api/racks/${rackId}`);
                const data = await response.json();
                
                if (!data.success || !data.rack) {
                    showError('Failed to load rack details');
                    return;
                }
                
                const rack = data.rack;
                currentRackData = rack;
                
                // Debug: Log the rack structure
                console.log('Rack data structure:', rack);
                
                // Update modal content
                document.getElementById('modal-rack-name').textContent = rack.rack_name || rack.filename;
                document.getElementById('modal-producer').textContent = rack.user_info?.producer_name || 'Unknown';
                document.getElementById('modal-date').textContent = new Date(rack.created_at).toLocaleDateString();
                document.getElementById('modal-type').textContent = rack.analysis?.rack_type || 'Audio Effect Rack';
                document.getElementById('modal-description').textContent = rack.user_info?.description || 'No description provided';
                
                // Render tags
                const tags = rack.tags || rack.user_info?.tags || [];
                const tagsContainer = document.getElementById('modal-tags');
                if (tags.length > 0) {
                    tagsContainer.innerHTML = `
                        <h4 style="margin-bottom: 0.5rem; color: #999;">Tags</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${tags.map(tag => `<span class="rack-card-tag">${tag}</span>`).join('')}
                        </div>
                    `;
                } else {
                    tagsContainer.innerHTML = '';
                }
                
                // Update stats - use pre-calculated stats or calculate from analysis
                const chains = rack.analysis?.chains || [];
                const totalDevices = rack.stats?.total_devices || chains.reduce((sum, chain) => sum + (chain.devices?.length || 0), 0);
                const macros = rack.analysis?.macro_controls || [];
                
                document.getElementById('stat-chains').textContent = chains.length;
                document.getElementById('stat-devices').textContent = totalDevices;
                document.getElementById('stat-macros').textContent = macros.length;
                
                // Render chains visualization
                renderChains(chains);
                
                // Render macro controls
                if (macros.length > 0) {
                    renderMacros(macros);
                    document.getElementById('modal-macro-controls').classList.remove('hidden');
                } else {
                    document.getElementById('modal-macro-controls').classList.add('hidden');
                }
                
                // Show modal
                document.getElementById('rack-modal').style.display = 'block';
                document.body.style.overflow = 'hidden';
                
            } catch (error) {
                console.error('Failed to load rack details:', error);
                showError('Failed to load rack details');
            }
        }
        
        // Render chains visualization
        function renderChains(chains) {
            const container = document.getElementById('modal-chains-container');
            
            if (chains.length === 0) {
                container.innerHTML = '<p style="color: #666;">No chains found</p>';
                return;
            }
            
            container.innerHTML = chains.map((chain, index) => `
                <div class="chain">
                    <div class="chain-header">
                        <span class="chain-name">${chain.name || `Chain ${index + 1}`}</span>
                        ${chain.volume !== undefined ? `<span class="chain-volume">Vol: ${chain.volume}dB</span>` : ''}
                    </div>
                    <div class="devices">
                        ${(chain.devices || []).map(device => `
                            <div class="device">
                                <div class="device-header">
                                    <span class="device-name">${device.name}</span>
                                    <span class="device-state ${device.on ? 'on' : ''}">${device.on ? 'ON' : 'OFF'}</span>
                                </div>
                                ${device.parameters && Object.keys(device.parameters).length > 0 ? `
                                    <div class="device-params">
                                        ${Object.entries(device.parameters).slice(0, 3).map(([key, value]) => 
                                            `${key}: ${value}`
                                        ).join(' • ')}
                                        ${Object.keys(device.parameters).length > 3 ? ' ...' : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        // Render macro controls
        function renderMacros(macros) {
            const container = document.getElementById('modal-macro-list');
            
            container.innerHTML = macros.map((macro, index) => `
                <div class="macro-item">
                    <div class="macro-name">Macro ${index + 1}: ${macro.name || 'Unnamed'}</div>
                    <div class="macro-value">Value: ${macro.value !== undefined ? macro.value : 'N/A'}</div>
                </div>
            `).join('');
        }
        
        // Close modal (made global for onclick)
        window.closeModal = function() {
            document.getElementById('rack-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
            currentRackData = null;
        }
        
        // Download JSON (made global for onclick)
        window.downloadJSON = function() {
            if (!currentRackData) return;
            
            const dataStr = JSON.stringify(currentRackData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentRackData.filename || 'rack'}_analysis.json`;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('rack-modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Show error message
        function showError(message) {
            rackGrid.innerHTML = `<div class="error-message">${message}</div>`;
        }

        // Event listeners
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // Initialize
        loadPopularTags();
        performSearch(); // Load recent racks initially
    </script>
</body>
</html>
