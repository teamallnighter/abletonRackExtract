<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Racks - Ableton Rack Analyzer</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .search-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .search-header {
            margin-bottom: 2rem;
        }
        
        .search-controls {
            background: #2a2a2a;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .search-input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .search-input {
            flex: 1;
            padding: 0.75rem;
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            color: #fff;
            font-size: 1rem;
        }
        
        .search-button {
            padding: 0.75rem 1.5rem;
            background: #ff6b00;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .search-button:hover {
            background: #e55a00;
        }
        
        .filter-tags {
            margin-top: 1rem;
        }
        
        .filter-tags-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #999;
            font-size: 0.9rem;
        }
        
        .filter-tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .filter-tag {
            padding: 0.25rem 0.75rem;
            background: #333;
            border: 1px solid #444;
            border-radius: 20px;
            color: #ccc;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .filter-tag:hover {
            background: #444;
            color: #fff;
        }
        
        .filter-tag.active {
            background: #ff6b00;
            border-color: #ff6b00;
            color: white;
        }
        
        .search-results {
            margin-top: 2rem;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .results-count {
            color: #999;
        }
        
        .rack-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .rack-card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .rack-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .rack-card h3 {
            margin-bottom: 0.5rem;
            color: #ff6b00;
        }
        
        .rack-card-meta {
            color: #999;
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
        }
        
        .rack-card-description {
            color: #ccc;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .rack-card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        
        .rack-card-tag {
            padding: 0.2rem 0.5rem;
            background: #1a1a1a;
            border-radius: 12px;
            color: #888;
            font-size: 0.75rem;
        }
        
        .no-results {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .loading-spinner {
            text-align: center;
            padding: 2rem;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 1rem;
            color: #ff6b00;
            text-decoration: none;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <header>
        <h1>Ableton Rack Analyzer</h1>
        <p class="subtitle">Search and explore analyzed racks</p>
    </header>

    <main class="search-container">
        <a href="/" class="back-link">← Back to Analyzer</a>
        
        <div class="search-header">
            <h2>Search Racks</h2>
        </div>
        
        <div class="search-controls">
            <div class="search-input-group">
                <input 
                    type="text" 
                    id="search-input" 
                    class="search-input" 
                    placeholder="Search by rack name, filename, or description..."
                    autofocus
                >
                <button id="search-button" class="search-button">Search</button>
            </div>
            
            <div class="filter-tags">
                <label class="filter-tags-label">Filter by tags:</label>
                <div id="filter-tags-container" class="filter-tags-container">
                    <!-- Popular tags will be loaded here -->
                </div>
            </div>
        </div>
        
        <div class="search-results">
            <div class="results-header">
                <h3>Results</h3>
                <span id="results-count" class="results-count"></span>
            </div>
            
            <div id="loading-spinner" class="loading-spinner hidden">
                <div class="spinner"></div>
                <p>Searching...</p>
            </div>
            
            <div id="rack-grid" class="rack-grid">
                <!-- Search results will be displayed here -->
            </div>
            
            <div id="no-results" class="no-results hidden">
                <p>No racks found. Try a different search term or adjust your filters.</p>
            </div>
        </div>
    </main>

    <script>
        // State management
        let selectedTags = new Set();
        let popularTags = [];
        let currentSearchQuery = '';

        // DOM elements
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const filterTagsContainer = document.getElementById('filter-tags-container');
        const rackGrid = document.getElementById('rack-grid');
        const resultsCount = document.getElementById('results-count');
        const loadingSpinner = document.getElementById('loading-spinner');
        const noResults = document.getElementById('no-results');

        // Load popular tags
        async function loadPopularTags() {
            try {
                const response = await fetch('/api/tags/popular');
                const data = await response.json();
                
                if (data.success && data.tags) {
                    popularTags = data.tags;
                    renderFilterTags();
                }
            } catch (error) {
                console.error('Failed to load popular tags:', error);
            }
        }

        // Render filter tags
        function renderFilterTags() {
            filterTagsContainer.innerHTML = popularTags.map(tag => `
                <div class="filter-tag" data-tag="${tag.tag}">
                    ${tag.tag} (${tag.count})
                </div>
            `).join('');
            
            // Add click handlers
            filterTagsContainer.querySelectorAll('.filter-tag').forEach(el => {
                el.addEventListener('click', () => toggleTag(el.dataset.tag));
            });
        }

        // Toggle tag selection
        function toggleTag(tag) {
            if (selectedTags.has(tag)) {
                selectedTags.delete(tag);
            } else {
                selectedTags.add(tag);
            }
            
            // Update UI
            filterTagsContainer.querySelectorAll('.filter-tag').forEach(el => {
                if (selectedTags.has(el.dataset.tag)) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });
            
            // Perform search with updated filters
            performSearch();
        }

        // Perform search
        async function performSearch() {
            const query = searchInput.value.trim();
            currentSearchQuery = query;
            
            // Show loading state
            loadingSpinner.classList.remove('hidden');
            rackGrid.innerHTML = '';
            noResults.classList.add('hidden');
            
            try {
                let results = [];
                
                // If we have selected tags, search by tags
                if (selectedTags.size > 0) {
                    const tagResponse = await fetch('/api/racks/by-tags', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tags: Array.from(selectedTags) })
                    });
                    const tagData = await tagResponse.json();
                    
                    if (tagData.success) {
                        results = tagData.racks || [];
                    }
                }
                
                // If we have a text query, either filter tag results or search by text
                if (query) {
                    if (selectedTags.size > 0) {
                        // Filter existing results by query
                        results = results.filter(rack => {
                            const searchStr = `${rack.name || ''} ${rack.filename || ''} ${rack.user_info?.description || ''}`.toLowerCase();
                            return searchStr.includes(query.toLowerCase());
                        });
                    } else {
                        // Search by text only
                        const textResponse = await fetch(`/api/racks/search?q=${encodeURIComponent(query)}`);
                        const textData = await textResponse.json();
                        
                        if (textData.success) {
                            results = textData.racks || [];
                        }
                    }
                } else if (selectedTags.size === 0) {
                    // No query and no tags - show recent racks
                    const recentResponse = await fetch('/api/racks?limit=20');
                    const recentData = await recentResponse.json();
                    
                    if (recentData.success) {
                        results = recentData.racks || [];
                    }
                }
                
                // Display results
                displayResults(results);
                
            } catch (error) {
                console.error('Search failed:', error);
                showError('Search failed. Please try again.');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        // Display search results
        function displayResults(racks) {
            if (racks.length === 0) {
                noResults.classList.remove('hidden');
                resultsCount.textContent = '0 racks found';
                return;
            }
            
            noResults.classList.add('hidden');
            resultsCount.textContent = `${racks.length} rack${racks.length !== 1 ? 's' : ''} found`;
            
            rackGrid.innerHTML = racks.map(rack => {
                const userInfo = rack.user_info || {};
                const tags = rack.tags || userInfo.tags || [];
                const description = userInfo.description || 'No description provided';
                const producer = userInfo.producer_name || 'Unknown';
                const date = new Date(rack.created_at).toLocaleDateString();
                
                return `
                    <div class="rack-card" onclick="viewRack('${rack._id}')">
                        <h3>${rack.name || rack.filename}</h3>
                        <div class="rack-card-meta">
                            by ${producer} • ${date}
                        </div>
                        <div class="rack-card-description">${description}</div>
                        ${tags.length > 0 ? `
                            <div class="rack-card-tags">
                                ${tags.map(tag => `<span class="rack-card-tag">${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // View rack details
        function viewRack(rackId) {
            // For now, just log - you can implement a detail view later
            console.log('View rack:', rackId);
            // window.location.href = `/rack/${rackId}`;
        }

        // Show error message
        function showError(message) {
            rackGrid.innerHTML = `<div class="error-message">${message}</div>`;
        }

        // Event listeners
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // Initialize
        loadPopularTags();
        performSearch(); // Load recent racks initially
    </script>
</body>
</html>
