<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Racks - Ableton Rack Analyzer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Ableton Rack Analyzer</h1>
        <p class="subtitle">Search and explore analyzed racks</p>
    </header>

    <main class="search-container">
        <a href="/" class="back-link">← Back to Analyzer</a>
        
        <div class="search-header">
            <h2>Search Racks</h2>
        </div>
        
        <div class="search-controls">
            <div class="search-input-group">
                <input 
                    type="text" 
                    id="search-input" 
                    class="search-input" 
                    placeholder="Search by rack name, filename, or description..."
                    autofocus
                >
                <button id="search-button" class="search-button">Search</button>
            </div>
            
            <div class="filter-tags">
                <label class="filter-tags-label">Filter by tags:</label>
                <div id="filter-tags-container" class="filter-tags-container">
                    <!-- Popular tags will be loaded here -->
                </div>
            </div>
        </div>
        
        <div class="search-results">
            <div class="results-header">
                <h3>Results</h3>
                <span id="results-count" class="results-count"></span>
            </div>
            
            <div id="loading-spinner" class="loading-spinner hidden">
                <div class="spinner"></div>
                <p>Searching...</p>
            </div>
            
            <div id="rack-grid" class="rack-grid">
                <!-- Search results will be displayed here -->
            </div>
            
            <div id="no-results" class="no-results hidden">
                <p>No racks found. Try a different search term or adjust your filters.</p>
            </div>
        </div>
    </main>

    <script>
        // State management
        let selectedTags = new Set();
        let popularTags = [];
        let currentSearchQuery = '';

        // DOM elements
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const filterTagsContainer = document.getElementById('filter-tags-container');
        const rackGrid = document.getElementById('rack-grid');
        const resultsCount = document.getElementById('results-count');
        const loadingSpinner = document.getElementById('loading-spinner');
        const noResults = document.getElementById('no-results');

        // Load popular tags
        async function loadPopularTags() {
            try {
                const response = await fetch('/api/tags/popular');
                const data = await response.json();
                
                if (data.success && data.tags) {
                    popularTags = data.tags;
                    renderFilterTags();
                }
            } catch (error) {
                console.error('Failed to load popular tags:', error);
            }
        }

        // Render filter tags
        function renderFilterTags() {
            filterTagsContainer.innerHTML = popularTags.map(tag => `
                <div class="filter-tag" data-tag="${tag.name}">
                    ${tag.name} (${tag.count})
                </div>
            `).join('');
            
            // Add click handlers
            filterTagsContainer.querySelectorAll('.filter-tag').forEach(el => {
                el.addEventListener('click', () => toggleTag(el.dataset.tag));
            });
        }

        // Toggle tag selection
        function toggleTag(tag) {
            if (selectedTags.has(tag)) {
                selectedTags.delete(tag);
            } else {
                selectedTags.add(tag);
            }
            
            // Update UI
            filterTagsContainer.querySelectorAll('.filter-tag').forEach(el => {
                if (selectedTags.has(el.dataset.tag)) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });
            
            // Perform search with updated filters
            performSearch();
        }

        // Perform search
        async function performSearch() {
            const query = searchInput.value.trim();
            currentSearchQuery = query;
            
            // Show loading state
            loadingSpinner.classList.remove('hidden');
            rackGrid.innerHTML = '';
            noResults.classList.add('hidden');
            
            try {
                let results = [];
                
                // If we have selected tags, search by tags
                if (selectedTags.size > 0) {
                    const tagResponse = await fetch('/api/racks/by-tags', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tags: Array.from(selectedTags) })
                    });
                    const tagData = await tagResponse.json();
                    
                    if (tagData.success) {
                        results = tagData.racks || [];
                    }
                }
                
                // If we have a text query, either filter tag results or search by text
                if (query) {
                    if (selectedTags.size > 0) {
                        // Filter existing results by query
                        results = results.filter(rack => {
                            const searchStr = `${rack.name || ''} ${rack.filename || ''} ${rack.user_info?.description || ''}`.toLowerCase();
                            return searchStr.includes(query.toLowerCase());
                        });
                    } else {
                        // Search by text only
                        const textResponse = await fetch(`/api/racks/search?q=${encodeURIComponent(query)}`);
                        const textData = await textResponse.json();
                        
                        if (textData.success) {
                            results = textData.racks || [];
                        }
                    }
                } else if (selectedTags.size === 0) {
                    // No query and no tags - show recent racks
                    const recentResponse = await fetch('/api/racks?limit=20');
                    const recentData = await recentResponse.json();
                    
                    if (recentData.success) {
                        results = recentData.racks || [];
                    }
                }
                
                // Display results
                displayResults(results);
                
            } catch (error) {
                console.error('Search failed:', error);
                showError('Search failed. Please try again.');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        // Display search results
        function displayResults(racks) {
            if (racks.length === 0) {
                noResults.classList.remove('hidden');
                resultsCount.textContent = '0 racks found';
                return;
            }
            
            noResults.classList.add('hidden');
            resultsCount.textContent = `${racks.length} rack${racks.length !== 1 ? 's' : ''} found`;
            
                rackGrid.innerHTML = racks.map(rack => {
                const userInfo = rack.user_info || {};
                const tags = rack.tags || userInfo.tags || [];
                const description = userInfo.description || 'No description provided';
                const producer = userInfo.producer_name || 'Unknown';
                const date = new Date(rack.created_at).toLocaleDateString();
                
                return `
                    <div class="rack-card" onclick="viewRack('${rack._id}')">
                        <h3>${rack.rack_name || rack.filename}</h3>
                        <div class="rack-card-meta">
                            by ${producer} • ${date}
                        </div>
                        <div class="rack-card-description">${description}</div>
                        ${tags.length > 0 ? `
                            <div class="rack-card-tags">
                                ${tags.map(tag => `<span class="rack-card-tag">${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // View rack details (made global for onclick)
        window.viewRack = function(rackId) {
            // Navigate to the individual rack page
            window.location.href = `/rack/${rackId}`;
        }

        // Show error message
        function showError(message) {
            rackGrid.innerHTML = `<div class="error-message">${message}</div>`;
        }

        // Event listeners
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // Initialize
        loadPopularTags();
        performSearch(); // Load recent racks initially
    </script>
</body>
</html>
