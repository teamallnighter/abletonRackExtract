name: ğŸš€ Build and Deploy Frontend

on:
  push:
    branches: [ main ]
    paths: 
      - 'frontend-new/**'
      - '.github/workflows/deploy.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend-new/**'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'frontend-new/package-lock.json'

    - name: ğŸ“¦ Install dependencies
      working-directory: ./frontend-new
      run: npm ci

    - name: ğŸ—ï¸ Build React app
      working-directory: ./frontend-new
      run: npm run build

    - name: ğŸ“‹ Copy build to backend
      run: |
        # Remove old build files
        rm -rf backend/static/frontend/*
        # Copy new build files
        cp -r frontend-new/dist/* backend/static/frontend/
        
    - name: ğŸ” Check if there are changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ’¾ Commit and push changes (main branch only)
      if: steps.verify-changed-files.outputs.changed == 'true' && github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add backend/static/frontend/
        git commit -m "ğŸ¤– Auto-deploy: Update frontend build from ${{ github.sha }}"
        git push

    - name: âœ… Build completed
      run: |
        echo "ğŸ‰ Frontend build completed successfully!"
        if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
          if [ "${{ github.ref }}" == "refs/heads/main" ] && [ "${{ github.event_name }}" == "push" ]; then
            echo "ğŸ“¦ Changes committed and pushed to trigger Railway deployment"
          else
            echo "ğŸ” Changes detected but not deployed (not main branch push)"
          fi
        else
          echo "ğŸ“ No changes detected in build output"
        fi
